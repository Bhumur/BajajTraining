package com.example.demo;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLClientInfoException;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import com.example.demo.entity.Customer;
import com.example.demo.entity.Doctor;
import com.example.demo.entity.Patient;
import com.example.demo.entity.repositry.CustomerRepoImpl;
import com.example.demo.entity.utils.Status;
import com.example.demo.utils.ConnectionUtils;

public class JdbcApplication {
	
	public static Doctor getDoctorById(int id, List<Doctor> list) {
		for(Doctor d : list) {
			if(d.getDoctorId()==id) {
				return d;
			}
		}
		return null;
	}
	
	public static void usingJoins(Connection con) throws SQLException {
		List<Doctor> doctorList = new ArrayList<>();
		String sqlJoin = "select d.doctorid ,d.doctorname, d.department, p.patientid, p.patientname  from patient as p join doctor as d on p.doctorid=d.doctorid;";
		
		try(PreparedStatement query = con.prepareStatement(sqlJoin);
				ResultSet rs = query.executeQuery()){
			System.out.println("Starting :-----------");
			System.out.println("Is Cursor Before First : " + rs.isBeforeFirst());
			while(rs.next()) {
				int doctorId = rs.getInt(1);
				String doctorName = rs.getString(2);
				String department = rs.getString(3);
				int patientId = rs.getInt(4);
				String patientName = rs.getString(5);
				Doctor doctor = getDoctorById(rs.getInt(1), doctorList);
				List<Patient> patientList;
				if(doctor==null) {
					patientList = new ArrayList<>();
					doctor = new Doctor(doctorId, doctorName, department, patientList);
					doctorList.add(doctor);
				}
				else {
					patientList = doctor.getPatientList();
				}
				patientList.add(new Patient(patientId, patientName));
			}
			
		}catch(SQLClientInfoException e) {
			
		}
		System.out.println(doctorList.size());
		for(Doctor d : doctorList) {
			System.out.println(d);
		}
	}

	public static void printCustomers(List<Customer> list) {
		for(Customer c : list)
			System.out.println(c);
	}
	public static void main(String[] args) {
		CustomerRepoImpl repo = null;
		try(Connection connection =  ConnectionUtils.getMySqlConnection()) {
			System.out.println(connection);
			repo = new CustomerRepoImpl(connection);
			
			//*********** JDBC
			
			
			
//			repo.add(new Customer(1,"Bhumur Agrawal", LocalDate.parse("2000-02-15"),523.46, Status.COMPLETED));
//			repo.add(new Customer(2,"Rehan Agrawal", LocalDate.parse("2000-02-15"),523.46, Status.COMPLETED));
//
//			System.out.println(repo.findById(1));
//			System.out.println(repo.remove(1));
//			List<Customer> list = (List<Customer>) repo.findAll();
//			printCustomers(list);
			
			
			//*********** Using Join
			
//			usingJoins(connection);
			
			
			
			// ******** Batch 
			
			repo.addAll(new Customer[] {
					new Customer(1255, "Sarvesh", LocalDate.parse("2005-02-15"), 15623.656, Status.BILLED),
					new Customer(1355, "Abhishek", LocalDate.parse("2008-02-15"), 15623.656, Status.PENDING),
					new Customer(1445, "Chetan", LocalDate.parse("2015-02-15"), 15623.656, Status.COMPLETED)					
			});
			
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
