package com.example.demo;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLClientInfoException;
import java.sql.SQLException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import com.example.demo.entity.Customer;
import com.example.demo.entity.Doctor;
import com.example.demo.entity.Patient;
import com.example.demo.entity.repositry.CustomerRepoImpl;
import com.example.demo.entity.utils.Status;
import com.example.demo.utils.ConnectionUtils;

public class JdbcApplication {
	
	public static Doctor getDoctorById(int id, List<Doctor> list) {
		for(Doctor d : list) {
			if(d.getDoctorId()==id) {
				return d;
			}
		}
		return null;
	}
	
	public static void usingJoins(Connection con) throws SQLException {
		List<Doctor> doctorList = new ArrayList<>();
		String sqlJoin = "select d.doctorname, d.doctorid, d.department, p.patientid, p.patientname  from patient as p right outer join doctor as d on p.doctorid=d.doctorid;";
		
		try(PreparedStatement query = con.prepareStatement(sqlJoin);
				ResultSet rs = query.executeQuery()){
			while(rs.next()) {
				int doctorId = rs.getInt(1);
				String doctorName = rs.getString(2);
				String department = rs.getString(3);
				int patientId = rs.getInt(4);
				String patientName = rs.getString(5);
				Doctor doctor = getDoctorById(rs.getInt(1), doctorList);
				List<Patient> patientList;
				if(doctor==null) {
					doctor = new Doctor(doctorId, doctorName, department, null);
					patientList = new ArrayList<>();
				}
				else {
					patientList = doctor.getPatientList();
				}
				patientList.add(new Patient(patientId, patientName));
				
				
				
				System.out.println(rs.getInt(1) + " " + rs.getString(2) + " " + rs.getString(3));
			}
			
		}catch(SQLClientInfoException e) {
			
		}
	}

	public static void printCustomers(List<Customer> list) {
		for(Customer c : list)
			System.out.println(c);
	}
	public static void main(String[] args) {
		CustomerRepoImpl repo = null;
		try(Connection connection =  ConnectionUtils.getMySqlConnection()) {
//			System.out.println(connection);
//			repo = new CustomerRepoImpl(connection);
//			repo.add(new Customer(1,"Bhumur Agrawal", LocalDate.parse("2000-02-15"),523.46, Status.COMPLETED));
//			repo.add(new Customer(2,"Rehan Agrawal", LocalDate.parse("2000-02-15"),523.46, Status.COMPLETED));
//
//			System.out.println(repo.findById(1));
//			System.out.println(repo.remove(1));
//			List<Customer> list = (List<Customer>) repo.findAll();
//			printCustomers(list);
//			
			
			usingJoins(connection);
			
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}
