package com.example.demo;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.ResourceBundle;
import java.util.Set;

import com.example.demo.entity.Bank;
import com.example.demo.entity.Customer;

public class Application {

	public static void main(String []args) {
		
		List<Bank> bankList = new ArrayList<>();
		List<Customer> customerList = new ArrayList<>();
		
		Set<Bank> bankSet = new HashSet<>();
		Set<Customer> customerSet = new HashSet<>();
		
		String sql = "Select b.bankid, b.bankname, c.customerid, c.customername from bank as b join customer as c join bankcustomer as bc on bc.bankid = b.bankid and bc.customerid = c.customerid;";
		ResourceBundle bundle = ResourceBundle.getBundle("application");
		String url = bundle.getString("datasource.url");
		String username = bundle.getString("datasource.username");
		String password = bundle.getString("datasource.password");
		
		try(Connection connection = DriverManager.getConnection(url,username,password);
				PreparedStatement query = connection.prepareStatement(sql);
				ResultSet rs = query.executeQuery()){
			while(rs.next()) {
				int bankid = rs.getInt(1);
				String bankname = rs.getString(2);
				int customerid = rs.getInt(3);
				String customername = rs.getString(4);
				Bank bank = new Bank(bankid, bankname);
				Customer customer = new Customer(customerid, customername);
				
				if(bankSet.contains(bank)) {
					List<Customer> list = bank.getCustomerList();
					if(!customerSet.contains(customer)) {
						 
					}
				}
				else {
					List<Customer> list = new ArrayList<>();
					bank.setCustomerList(list);
				}
				
				List<Customer> clist;
				if(bankList.contains(bank))
				{
					bank = getBank(bank, bankList);
					clist = bank.getCustomerList();
					clist.add(new Customer(customerid, customername));
				}
				else {
					clist = new ArrayList<>();
					clist.add(new Customer(customerid, customername));
					bank.setCustomerList(clist);
					bankList.add(bank);
				}
			}
			for(Bank bank : bankList)
				System.out.println(bank);
			
		}catch (SQLException e) {
			e.printStackTrace();
		}
		
	}

	private static Bank getBank(Bank bank, List<Bank> bankList) {
		for(Bank eachBank : bankList) {
			if(eachBank.equals(bank))
				return eachBank;
		}
		return null;
	}
}
